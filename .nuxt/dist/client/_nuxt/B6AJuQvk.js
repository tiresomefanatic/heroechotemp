import{_ as G,a as M}from"./pM-iUErY.js";import T from"./C7HLUogG.js";import{g as z,r as v,h as K,i as E,j as J,k,l as Q,m as W,o as c,c as l,d,w as m,n as f,H as X,b as g,p as x,q as N,t as Y,s as Z,a as ee}from"./dmCFEmAA.js";import{u as te}from"./go0Cx3TC.js";import{u as ne}from"./BJUUIQP3.js";import{u as oe,q as _}from"./CIvJWGbK.js";import ae from"./sggmdMDz.js";import"./C53o3tHu.js";import"./BpTm7Slx.js";import"./Byns4Lnc.js";import"./BNrw_4B8.js";import"./D1buzzy2.js";import"./D-fmbwf5.js";import"./Dym_awWQ.js";import"./BmlbPuZL.js";import"./B4ZzplNY.js";import"./DY7prswQ.js";import"./B4n-T8Sk.js";const se=window.setInterval,re={class:"page-wrapper"},ie={key:0},ce={key:0,class:"sidebar"},le={key:0,class:"content-header"},ue={key:0,class:"editor-container"},de={key:1,class:"prose-content"},he=z({__name:"[...slug]",async setup(me){let p,S;const{getRawContent:R,saveFileContent:q,isLoggedIn:y,currentBranch:s}=te(),{showToast:h}=ne(),A=v(!1),a=v(!1),w=v(""),F=v(null),C=K().params.slug||[],n=Array.isArray(C)?C.join("/"):C,P=E(()=>n!==""),B=E(()=>`${n}-${Date.now()}`),{data:b}=([p,S]=J(()=>oe(`content-${n}`,()=>n?_().where({_path:`/${n}`}).findOne():_().where({_path:"/"}).findOne(),{immediate:!0,server:!0})),p=await p,S(),p),u=E(()=>n?`content/${n}.md`:"content/index.md"),O=async()=>{var e;try{const t=await fetch(`https://api.github.com/repos/tiresomefanatic/heroechotemp/commits?path=${u.value}&sha=${s.value}`,{headers:{Accept:"application/vnd.github.v3+json"}});if(!t.ok)throw new Error("Failed to fetch commit info");const o=(e=(await t.json())[0])==null?void 0:e.sha;return o!==F.value?(console.log("New commit detected, refreshing content..."),F.value=o,!0):!1}catch(t){return console.error("Error checking content freshness:",t),!0}},i=async(e=!1)=>{var t;A.value=!0;try{if(e||await O()){console.log(`Fetching fresh content at ${new Date().toISOString()}`),console.log(`Branch: ${s.value}, Path: ${u.value}`);const o=await R("tiresomefanatic","heroechotemp",u.value,s.value);console.log("Raw content fetched:",{length:(o==null?void 0:o.length)||0,preview:o==null?void 0:o.substring(0,500)}),w.value=o;{const $=(t=Z().$content)==null?void 0:t.storage;console.log("Current content storage:",$),$&&(await $.clearAll(),console.log("Cleared content storage"));const I=await(n?_().where({_path:`/${n}`}):_().where({_path:"/"})).findOne();console.log("New content fetched:",I),b.value=I,console.log("Final data state:",{dataValue:b.value,path:n,contentPath:u.value})}console.log("Content loaded and refreshed successfully")}}catch(r){console.error("Content loading error:",r),console.error("Full error details:",{name:r.name,message:r.message,stack:r.stack}),h({title:"Error",message:`Failed to load content from branch: ${s.value}`,type:"error"})}finally{A.value=!1}},D=async()=>{document.visibilityState==="visible"&&!a.value&&await i()},V=async()=>{if(!y.value){h({title:"Authentication Required",message:"Please sign in with GitHub to edit content",type:"warning"});return}a.value=!0,await i(!0)},j=e=>{w.value=e},L=async e=>{if(!e||!y.value){h({title:"Error",message:"Please sign in to save changes",type:"error"});return}try{if(console.log(`Saving content to branch: ${s.value}`),await q("tiresomefanatic","heroechotemp",u.value,e,`Update ${u.value}`,s.value))h({title:"Success",message:`Content saved successfully to branch: ${s.value}`,type:"success"}),await i(!0),a.value=!1;else throw new Error(`Failed to save to branch: ${s.value}`)}catch(t){console.error("Error saving content:",t),h({title:"Error",message:`Failed to save to branch: ${s.value}`,type:"error"})}},H=e=>{h({title:"Editor Error",message:e.message,type:"error"})},U=async()=>{await i(!0),a.value=!1};return k(a,async(e,t)=>{e&&!t&&await i(!0)}),k(s,async(e,t)=>{e!==t&&(console.log(`Branch changed from ${t} to ${e}, reloading content...`),await i(!0))}),k(u,async(e,t)=>{e!==t&&await i(!0)}),Q(()=>{{i(!0),document.addEventListener("visibilitychange",D);const e=se(async()=>{a.value||await i()},3e4);W(()=>{clearInterval(e),document.removeEventListener("visibilitychange",D)})}}),(e,t)=>{const r=M,o=T;return c(),l("div",re,[d(r,null,{default:m(()=>[f(b)?(c(),l("div",ie,[d(X),g("div",{class:N(["content-area",{"editing-mode":a.value}])},[!a.value&&P.value?(c(),l("aside",ce,[d(ae)])):x("",!0),g("div",{class:N(["main-content",{"with-sidebar":!a.value&&P.value}])},[f(y)?(c(),l("div",le,[d(r,null,{default:m(()=>[a.value?(c(),l("button",{key:1,onClick:U,class:"edit-button"}," Exit ")):(c(),l("button",{key:0,onClick:V,class:"edit-button"}," Edit "))]),_:1})])):x("",!0),d(r,null,{default:m(()=>[a.value?(c(),l("div",ue,[d(G,{content:w.value,filePath:u.value,"onUpdate:content":j,onSave:L,onError:H},null,8,["content","filePath"])])):(c(),l("div",de,[(c(),l("div",{key:B.value},[d(o,{path:f(n),head:!1},{empty:m(()=>t[0]||(t[0]=[g("p",null,"No content found.",-1)])),"not-found":m(()=>[g("p",null,"Content not found. Path: "+Y(f(n)),1)]),_:1},8,["path"])]))]))]),_:1})],2)],2)])):x("",!0)]),_:1})])}}}),qe=ee(he,[["__scopeId","data-v-639f0781"]]);export{qe as default};
